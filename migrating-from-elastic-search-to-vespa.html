---
# Copyright Yahoo. All rights reserved.
title: Migrating from Elasticsearch
layout: page
---

<div class="container-full">
  <div class="m-t-20 row">
    <div class="xs-col-1-1 sm-col-1-1 md-col-1-1 lg-col-8-12 lg-col-off-2-12 xl-col-8-12 xl-col-off-2-12">
      <div class="flex-column">
        <div class="flex-column">
          <h1 id="migrating-from-elasticsearch">Migrating from Elasticsearch</h1>
          <p>
            This is a guide for how to move data from Elasticsearch (ES) to Vespa.
            By the end of this guide you will have exported documents from Elasticsearch,
            generated a deployable Vespa application package and tested this with documents and queries.
          </p>
          <p>
            Take a look at the <a href="vespa-elastic-solr">Elasticsearch / Solr / Vespa comparison</a>,
            and review <a href="#next-steps">next steps</a> for how to optimize for Vespa's features.
          </p>
          <p>
            <a href="https://github.com/vespa-engine/vespa/tree/master/config-model/src/main/python">ES_Vespa_parser.py</a>
            is provided for basic conversion of ES data and mappings to Vespa data and configuration.
            It is a basic script with minimal error checking -
            it is designed for a simple export, modify this as needed for your application's needs.
          </p>

          <h2 id="feed-a-sample-es-index">Feed a sample ES index</h2>
          <p>
            Set up an index with 1,000 sample documents using
            <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/getting-started-index.html">
              getting-started-index</a> or skip this part if you have an index:
          </p>
<pre data-test="exec">
$ docker network create --driver bridge esnet

$ docker run -d --rm --name esnode --network esnet -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" \
  docker.elastic.co/elasticsearch/elasticsearch:7.10.2

$ sleep 15 # Wait for elasticsearch to start
</pre>

Download test data and feed the data to elasticsearch:
<pre data-test="exec">
$ curl 'https://raw.githubusercontent.com/elastic/elasticsearch/7.10/docs/src/test/resources/accounts.json' \
  &gt; accounts.json

$ curl -H "Content-Type:application/json" --data-binary @accounts.json 'localhost:9200/bank/_bulk?pretty&refresh'
</pre>
Verify index
<pre data-test="exec" data-test-assert-contains="1000">
$ curl 'localhost:9200/_cat/indices?v'
</pre>

          <p>
            The last command should indicate 1,000 documents in the index.
          </p>

<h2 id="dump-documents-from-es">Dump documents from ES</h2>
<p>Refer to <a href="https://github.com/elasticsearch-dump/elasticsearch-dump">ElasticDump</a> for details.</p>

<pre data-test="exec">
$ echo "\
npm install elasticdump \n \
/dump/node_modules/.bin/elasticdump --input=http://esnode:9200/bank --output=bank_data.json    --type=data \n \
/dump/node_modules/.bin/elasticdump --input=http://esnode:9200/bank --output=bank_mapping.json --type=mapping" > dumpit.sh
</pre>

Dump the data:
<pre data-test="exec">
$ docker run --rm --name esdump --network esnet -v "$PWD":/dump -w /dump node:alpine sh dumpit.sh
$ docker rm -f esnode
$ docker network remove esnet    
</pre>

<h2 id="generate-vespa-documents-and-application-package">Generate Vespa documents and Application Package</h2>
<p>
Use <a href="https://github.com/vespa-engine/vespa/tree/master/config-model/src/main/python">
ES_Vespa_parser.py</a> to generate Vespa documents and configuration:
</p>
<pre data-test="exec">
$ curl 'https://raw.githubusercontent.com/vespa-engine/vespa/master/config-model/src/main/python/ES_Vespa_parser.py' \
  &gt; ES_Vespa_parser.py

$ python3 ./ES_Vespa_parser.py --application_name bank bank_data.json bank_mapping.json
</pre>
<p>
This generates documents in <code>documents.json</code>
(see <a href="https://docs.vespa.ai/en/reference/document-json-format.html">JSON format</a>)
where each document has IDs like this <code>id:bank:_doc::1</code>.
It also generates a <code>bank</code> folder with a <a href="https://docs.vespa.ai/en/application-packages.html">Vespa application package</a>.
</p>
<pre>
/bank
      │
      ├── documents.json
      ├── hosts.xml
      ├── services.xml
      └── /schemas
            ├── _doc.sd
            └── ...
</pre>


<h2 id="deploy">Deploy Vespa</h2>
<p>
  Install <a href="https://docs.vespa.ai/en/vespa-cli.html">Vespa CLI</a>. 
  In this example we use <a href="https://brew.sh/">Homebrew</a>, you can also
  download a vespa cli release from <a href="https://github.com/vespa-engine/vespa/releases">GitHub</a>.
</p>
<pre>
$ brew install vespa-cli
</pre>
<p>
  Set target env, it's also possible to deploy to <a href="https://cloud.vespa.ai/">Vespa Cloud</a>
using target cloud. For local deployment using docker image use 

<pre data-test="exec">
$ vespa config set target local
</pre>

For cloud deployment using <a href="https://cloud.vespa.ai/">Vespa Cloud</a>

<pre>
$ vespa config set target cloud
$ vespa config set application tenant-name.myapp.default
$ vespa auth login 
$ vespa auth cert
</pre>

See also <a href="https://cloud.vespa.ai/en/getting-started">Cloud Vespa getting started guide</a>. It's possible
to switch between local deployment and cloud deployment by changing the <em>config target</em>
</p>
<p>Run the Vespa container. We forward the deploy api port and the data plane serving port (8080).</p>
<pre data-test="exec">
$ docker run -m 4G --detach --name vespa --hostname vespa-es-tutorial \
  --publish 8080:8080 --publish 19071:19071 vespaengine/vespa
</pre>
<p></p>Verify that configuration service (deploy api) is ready:</p>

<pre data-test="exec" data-test-assert-contains="ready">
$ vespa status deploy --wait 300
</pre>
</p>
<p>Deploy the application package</p>
<pre data-test="exec" data-test-assert-contains="Success">
$ vespa deploy --wait 300 bank
</pre>

<p>Wait for the application endpoint to become available:</p>

<pre data-test="exec">
$ vespa status --wait 300
</pre>

<p>Index the documents we dumped from Elasticsearch. Download <a href="https://docs.vespa.ai/en/vespa-feed-client.html">Vespa feed client</a>:</p>

<pre data-test="exec">
$ FEED_CLI_REPO="https://repo1.maven.org/maven2/com/yahoo/vespa/vespa-feed-client-cli" \
    && FEED_CLI_VER=$(curl -Ss "${FEED_CLI_REPO}/maven-metadata.xml" | sed -n 's/.*&lt;release&gt;\(.*\)&lt;.*&gt;/\1/p') \
    && curl -SsLo vespa-feed-client-cli.zip ${FEED_CLI_REPO}/${FEED_CLI_VER}/vespa-feed-client-cli-${FEED_CLI_VER}-zip.zip \
    && unzip -o vespa-feed-client-cli.zip
</pre>
<p>Index documents:</p>

<pre data-test="exec">
  $ ./vespa-feed-client-cli/vespa-feed-client \
       --file bank/documents.json --endpoint http://localhost:8080
</pre>

<h2 id="querying-vespa">Querying Vespa</h2>
  
<p>Get a document using the <a href="https://docs.vespa.ai/en/document-v1-api-guide.html">Document API</a>:</p>

<pre data-test="exec" data-test-assert-contains="amberduke@pyrami.com">
$ curl -s http://localhost:8080/document/v1/bank/_doc/docid/1
</pre>

<p>Use the <a href="https://docs.vespa.ai/en/query-api.html">Query API</a> to count documents,
find <code>"totalCount":1000</code> in the output - then run a text query:
</p>

<pre data-test="exec" data-test-assert-contains='totalCount":1000'>
$ curl -H "Content-Type: application/json" \
  --data '{"yql" : "select * from sources * where true"}' \
  http://localhost:8080/search/
</pre>

<p>Run a simple query against the <em>firstname</em field:></p>
<pre data-test="exec" data-test-assert-contains='totalCount":1'>
$ curl -H "Content-Type: application/json" \
  --data '{"yql" : "select firstname,lastname from sources * where firstname contains \"amber\""}' \
  http://localhost:8080/search/
</pre>
<p>It's also possible to query using the vespa cli:</p>
<pre data-test="exec" data-test-assert-contains='totalCount": 1000'>
$ vespa query \
    'yql=select firstname,lastname from sources *  where true' 
</pre>

<h2 id="next-steps">Next steps</h2>
<p>
  Review the differences in document records, Vespa to the right:
</p>
<table>
  <tr>
    <td>
<pre>
{
    "_index": "bank",
    "_type": "_doc",
    "_id": "1",
    "_score": 1,
    "_source": {
      "account_number": 1,
      "balance": 39225,
      "firstname": "Amber",
      "lastname": "Duke",
      "age": 32,
      "gender": "M",
      "address": "880 Holmes Lane",
      "employer": "Pyrami",
      "email": "amberduke@pyrami.com",
      "city": "Brogan",
      "state": "IL"
    }
}
</pre>
  </td>
  <td>
<pre>
{

    "put": "id:bank:_doc::1",


    "fields": {
      "account_number": 1,
      "balance": 39225,
      "firstname": "Amber",
      "lastname": "Duke",
      "age": 32,
      "gender": "M",
      "address": "880 Holmes Lane",
      "employer": "Pyrami",
      "email": "amberduke@pyrami.com",
      "city": "Brogan",
      "state": "IL"
    }
}
</pre>
  </td>
  </tr>
</table>
  <p>
    The <a href="https://docs.vespa.ai/en/documents.html#document-ids">id</a> field <code>id:bank:_doc::1</code> is composed of:
  </p>
   <ul class="list p-l-30 p-b-10">
    <li>namespace: bank</li>
    <li>schema: _doc</li>
    <li>id: 1</li>
   </ul>
<p>
Read more in <a href="https://docs.vespa.ai/en/documents.html">Documents</a> and <a href="https://docs.vespa.ai/en/schemas.html">Schemas</a>.
            <!-- ToDo: namespace is normally only useful in document api (and doc expiry?) use cases -->
</p>
<p>
The schema is the key Vespa configuration file where field types 
and <a href="https://docs.vespa.ai/en/ranking.html">ranking</a> are configured.</p>
<p>
The schema (found in <code>_doc.sd</code>) also has <a href="https://docs.vespa.ai/en/schemas.html#indexing">indexing</a>settings, example:</p>
<pre>
search _doc {
    document _doc {
        field account_number type long {
            indexing: summary | attribute
        }
        field address type string {
            indexing: summary | index
        }
        ...
    }
}
</pre>

<h2 id="notes">Notes</h2>
<p>
The Vespa docker image used in this guide is the same as used in
<a href="https://docs.vespa.ai/en/operations/docker-containers.html">production</a> serving instances.
It is the full Vespa application running, with all features. Read more about Vespa components in the <a href="https://docs.vespa.ai/en/overview.html">Vespa overview</a>.
</p>
          <!-- ToDo: more here on how features are different, and how to think about this / migrate -->
        </div>
      </div>
    </div>
  </div>
</div>
<p>Tear down container:</p>
<pre data-test="exec">
$ docker rm -f vespa 
</pre>
